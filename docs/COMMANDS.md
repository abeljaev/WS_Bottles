# WebSocket API: Команды и События

Документация протокола общения между backend-клиентом (app) и Application.py через WebSocket.

**Порт:** 8765 (по умолчанию)
**Регистрация:** При подключении клиент отправляет строку `"app"` для идентификации

---

## Содержание

1. [Команды (app → server)](#команды-app--server)
2. [События (server → app)](#события-server--app)
3. [Состояния системы](#состояния-системы)
4. [Жизненный цикл операции](#жизненный-цикл-операции)

---

## Команды (app → server)

### get_device_info

| Параметр | Значение |
|----------|----------|
| **Что делает** | Запрашивает полную информацию об устройстве |
| **Когда вызывать** | При запуске клиента, периодически для мониторинга |
| **Формат** | `"get_device_info"` или `{"command": "get_device_info"}` |
| **Параметры** | Нет |
| **Ответ** | Событие `device_info` |

---

### get_photo

| Параметр | Значение |
|----------|----------|
| **Что делает** | Запрашивает фото с камеры через vision сервис |
| **Когда вызывать** | Диагностика, ручной запрос фото |
| **Формат** | `"get_photo"` или `{"command": "get_photo"}` |
| **Параметры** | Нет |
| **Ответ** | Событие `photo_ready` |
| **Таймаут** | 2 секунды |

**Примечания:**
- Фото сохраняется в папку `photos/` с timestamp в имени
- При недоступности vision возвращается ошибка
- Пока оставили локальное сохранение фото

---

### dump_container

| Параметр | Значение |
|----------|----------|
| **Что делает** | Инициирует сброс контейнера в сборник |
| **Когда вызывать** | После события `container_recognized` |
| **Формат** | `"dump_container:plastic"` или `{"command": "dump_container", "param": "plastic"}` |
| **Параметры** | `plastic` (PET бутылки) или `aluminium` (банки) |
| **Ответ** | Событие `container_dumped`, затем `container_accepted` |

**Примечания:**
- `plastic` → движение каретки влево
- `aluminium` → движение каретки вправо
- Переводит систему в состояние `DUMPING_PLASTIC` или `DUMPING_ALUMINUM`
- Таймаут движения: 3 секунды (при превышении → `hardware_error`)

**Альтернативные форматы JSON:**
```json
{"command": "dump_container", "param": "plastic"}
{"command": "dump_container", "container_type": "plastic"}
{"command": "dump_container", "type": "plastic"}
```

---

### container_unloaded

| Параметр | Значение |
|----------|----------|
| **Что делает** | Уведомляет о выгрузке мешка, сбрасывает счётчик |
| **Когда вызывать** | После физической выгрузки мешка оператором |
| **Формат** | `"container_unloaded:plastic"` или `{"command": "container_unloaded", "param": "plastic"}` |
| **Параметры** | `plastic` или `aluminium` |
| **Ответ** | Событие `container_unloaded_ack` |

**Примечания:**
- В СЧЕТЧИКИ ВСЕГДА В НУЛЕ (ОШИБКА ПЛК)

---

### restore_device

| Параметр | Значение |
|----------|----------|
| **Что делает** | Восстанавливает устройство из состояния ERROR |
| **Когда вызывать** | После возникновения аппаратной ошибки |
| **Формат** | `"restore_device"` или `{"command": "restore_device"}` |
| **Параметры** | Нет |
| **Ответ** | Событие `restore_device_ack` |

**Примечания:**
- Переводит систему из состояния `ERROR` в `IDLE`
- Обрабатывается только в состоянии `ERROR`

---

### Служебные PLC команды

Прямой доступ к регистрам ПЛК. Использовать с осторожностью.

| Команда | Что делает |
|---------|-----------|
| `cmd_full_clear_register` | Очищает все биты регистра команд |
| `cmd_force_move_carriage_left` | Принудительное движение каретки влево |
| `cmd_force_move_carriage_right` | Принудительное движение каретки вправо |
| `cmd_weight_error_reset` | Сброс ошибки взвешивания (НЕ РАБОТАЕТ; ОШИБКА ПЛК) |
| `cmd_reset_weight_reading` | Сброс показания весов (НЕ РАБОТАЕТ; ОШИБКА ПЛК) |

**Формат:** Строка с именем команды, например `"cmd_full_clear_register"`

---

### Команды-заглушки (не реализованы, так как нет в железе)

Возвращают `{..._ack: {status: "not_implemented"}}`:

| Команда | Назначение |
|---------|-----------|
| `enter_service_mode` | Вход в сервисный режим |
| `exit_service_mode` | Выход из сервисного режима |
| `unlock_door` | Разблокировка двери |
| `lock_door` | Блокировка двери |
| `open_shutter` | Открытие шторки |
| `reboot_device` | Перезагрузка устройства |

---

## События (server → app)

### receiver_not_empty

| Параметр | Значение |
|----------|----------|
| **Что означает** | В приёмнике появился контейнер |
| **Когда приходит** | При изменении состояния датчиков (bottle_exist или bank_exist = 1) |

```json
{
  "event": "receiver_not_empty",
  "data": {
    "bottle_exist": 0|1,
    "bank_exist": 0|1
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### receiver_empty

| Параметр | Значение |
|----------|----------|
| **Что означает** | Приёмник пуст |
| **Когда приходит** | При изменении состояния (оба датчика = 0) |

```json
{
  "event": "receiver_empty",
  "data": {},
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_detected

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер обнаружен, запущен процесс распознавания |
| **Когда приходит** | При освобождении завесы (рука убрана после вложения) |

```json
{
  "event": "container_detected",
  "data": {
    "plc_type": "bottle|bank|unknown"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

**Примечания:**
- `plc_type` может быть `unknown` если ПЛК ещё не определил тип
- После этого события система в состоянии `WAITING_VISION`

---

### container_recognized

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер успешно распознан |
| **Когда приходит** | Vision подтвердил тип контейнера |

```json
{
  "event": "container_recognized",
  "data": {
    "type": "PET|ALUMINUM",
    "confidence": 1.0
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

**Примечания:**
- `PET` = пластиковая бутылка
- `ALUMINUM` = алюминиевая банка
- После этого события можно отправлять `dump_container`

---

### container_not_recognized

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер не распознан или несовпадение |
| **Когда приходит** | Vision вернул "none" |

```json
{
  "event": "container_not_recognized",
  "data": {},
  "timestamp": "2025-01-15T12:34:56.789"
}
```

**С деталями несовпадения:**
```json
{
  "event": "container_not_recognized",
  "data": {
    "plc_type": "bottle",
    "vision_type": "bank"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_dumped

| Параметр | Значение |
|----------|----------|
| **Что означает** | Команда сброса отправлена в ПЛК |
| **Когда приходит** | Сразу после получения команды `dump_container` |

```json
{
  "event": "container_dumped",
  "data": {
    "container_type": "plastic|aluminium"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### container_accepted

| Параметр | Значение |
|----------|----------|
| **Что означает** | Контейнер успешно выгружен в сборник |
| **Когда приходит** | Датчик конца хода каретки сработал |

```json
{
  "event": "container_accepted",
  "data": {
    "type": "PET|ALUMINUM",
    "counter": 42
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

**Примечания:**
- `counter` — текущее количество контейнеров этого типа
- После этого система возвращается в `IDLE`

---

### container_unloaded_ack

| Параметр | Значение |
|----------|----------|
| **Что означает** | Подтверждение сброса счётчика мешка |
| **Когда приходит** | В ответ на команду `container_unloaded` |

```json
{
  "event": "container_unloaded_ack",
  "data": {
    "container_type": "plastic|aluminium"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### hardware_error

| Параметр | Значение |
|----------|----------|
| **Что означает** | Возникла аппаратная ошибка |
| **Когда приходит** | При обнаружении ошибки датчиков или таймауте |

```json
{
  "event": "hardware_error",
  "data": {
    "error_code": "weight_error",
    "message": "Ошибка взвешивания"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

**Коды ошибок:**

| Код | Описание |
|-----|----------|
| `weight_error` | Ошибка взвешивания |
| `weight_too_small` | Вес слишком маленький |
| `left_movement_error` | Ошибка движения каретки влево |
| `right_movement_error` | Ошибка движения каретки вправо |
| `carriage_left_timeout` | Таймаут движения каретки влево (3 сек) |
| `carriage_right_timeout` | Таймаут движения каретки вправо (3 сек) |

**Примечания:**
- При таймауте каретки система переходит в состояние `ERROR`
- Требуется команда `restore_device` для выхода из `ERROR`

---

### device_info

| Параметр | Значение |
|----------|----------|
| **Что означает** | Информация об устройстве |
| **Когда приходит** | В ответ на команду `get_device_info` |

```json
{
  "event": "device_info",
  "data": {
    "bottle_count": 15,
    "bank_count": 8,
    "bottle_fill_percent": 45,
    "bank_fill_percent": 30,
    "state": "idle",
    "left_sensor": 0,
    "center_sensor": 1,
    "right_sensor": 0,
    "weight_error": 0
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

**Поля:**
- `bottle_count` / `bank_count` — количество принятых контейнеров, НЕ РАБОТАЕТ
- `bottle_fill_percent` / `bank_fill_percent` — процент заполнения мешка, НЕ РАБОТАЕТ
- `state` — текущее состояние системы
- `left_sensor` / `center_sensor` / `right_sensor` — датчики каретки
- `weight_error` — флаг ошибки весов

---

### photo_ready

| Параметр | Значение |
|----------|----------|
| **Что означает** | Фото готово или ошибка получения |
| **Когда приходит** | В ответ на команду `get_photo` |

**Успех:**
```json
{
  "event": "photo_ready",
  "data": {
    "photo_base64": "base64_encoded_jpeg...",
    "photo_path": "photos/photo_20250115_123456_789.jpg"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

**Ошибка:**
```json
{
  "event": "photo_ready",
  "data": {
    "error": "vision_unavailable"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

### restore_device_ack

| Параметр | Значение |
|----------|----------|
| **Что означает** | Устройство восстановлено из ошибки |
| **Когда приходит** | В ответ на команду `restore_device` |

```json
{
  "event": "restore_device_ack",
  "data": {
    "status": "ok"
  },
  "timestamp": "2025-01-15T12:34:56.789"
}
```

---

## Состояния системы

| Состояние | Описание | Обрабатываемые команды |
|-----------|----------|------------------------|
| `idle` | Ожидание контейнера | Все команды |
| `waiting_vision` | Ожидание ответа от vision | Нет (только ожидание) |
| `dumping_plastic` | Сброс пластика влево | Нет (только ожидание датчика) |
| `dumping_aluminum` | Сброс алюминия вправо | Нет (только ожидание датчика) |
| `error` | Ошибка оборудования | `get_photo`, `get_device_info`, `dump_container`, `restore_device` |

---

## Жизненный цикл операции

```
┌─────────────────────────────────────────────────────────────────┐
│  1. ОБНАРУЖЕНИЕ                                                 │
│     Завеса освобождается → container_detected                   │
│     Состояние: IDLE → WAITING_VISION                            │
├─────────────────────────────────────────────────────────────────┤
│  2. РАСПОЗНАВАНИЕ                                               │
│     Vision + ПЛК работают параллельно                           │
│     → container_recognized (успех)                              │
│     → container_not_recognized (неудача/таймаут)                │
│     Состояние: WAITING_VISION → IDLE                            │
├─────────────────────────────────────────────────────────────────┤
│  3. СБРОС (если распознан)                                      │
│     Клиент отправляет: dump_container:plastic/aluminium         │
│     → container_dumped                                          │
│     Состояние: IDLE → DUMPING_PLASTIC/DUMPING_ALUMINUM          │
├─────────────────────────────────────────────────────────────────┤
│  4. ЗАВЕРШЕНИЕ                                                  │
│     Датчик конца хода → container_accepted                      │
│     Состояние: DUMPING_* → IDLE                                 │
├─────────────────────────────────────────────────────────────────┤
│  5. ВЫГРУЗКА МЕШКА (отдельный процесс)                          │
│     При заполнении 100%: container_unloaded:type                │
│     → container_unloaded_ack                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## Временные параметры

| Параметр | Значение | Описание |
|----------|----------|----------|
| `vision_timeout` | 2.0 сек | Таймаут ожидания vision + ПЛК |
| `dump_timeout` | 3.0 сек | Таймаут движения каретки |
| `carriage_reset_timeout` | 2.0 сек | Таймаут обнуления регистров |
| `update_data_period` | 0.1 сек | Период опроса ПЛК |
