# Backlog

Запланированные задачи и улучшения.

## Критические баги (CRITICAL)

### PLC.py
- [ ] **RtuServer вместо RtuMaster** — команды не уходят в реальный ПЛК, используется локальный сервер
- [ ] **Два регистра на адресе 25** — cmd_register и modbus_register_counter пересекаются
- [ ] **server.start() до add_block** — «Illegal data address» при раннем обращении

### Application.py
- [ ] **Deadlock в stop()** — running не сбрасывается перед join(), система зависает
- [ ] **signal_handler без cleanup** — sys.exit() без вызова stop(), ресурсы не освобождаются
- [ ] **TypeError при None timestamp** — vision_request_time и dump_started_time могут быть None

### WebSocket.py
- [ ] **stop() не закрывает event loop** — сокет остаётся привязанным, задачи висят
- [ ] **Дубликаты client_name** — новое подключение затирает старое, соединения теряются

### camera_manager.py
- [ ] **stop_capture не ждёт поток** — crash при обращении к освобождённому VideoCapture
- [ ] **Параллельные read() без sync** — capture_single_frame + _capture_loop конфликтуют

### inference_service.py
- [ ] **Нет cleanup при CancelledError** — камера и WebSocket остаются открытыми
- [ ] **race condition в VideoCapture** — параллельное чтение даёт битые кадры

### Взаимодействие компонентов
- [ ] **Однослотовый буфер сообщений** — при 2+ командах подряд первые теряются
- [ ] **send_to_client при неготовом loop** — команды теряются при старте
- [ ] **_modbus_lock блокирует всё** — при зависании Modbus автомат «залипает»

## Высокий приоритет (HIGH)

### Application.py
- [ ] **handle_get_photo блокирует main loop на 2с** — пропуск событий датчиков
- [ ] **PLC_update_data молча умирает** — main loop использует устаревшие данные
- [ ] **Команды игнорируются в WAITING_VISION** — нельзя отменить операцию

### WebSocket.py
- [ ] **Ошибка send не удаляет клиента** — сломанные соединения остаются в clients
- [ ] **broadcast глотает исключения** — не удаляет сломанные соединения
- [ ] **recv() не проверяет _running** — handler зависает при остановке
- [ ] **threading.Lock внутри coroutines** — риск deadlock

### inference_service.py
- [ ] **Блокирующие вызовы в asyncio loop** — camera.open(), predict() блокируют
- [ ] **Мульти-инференс по одному кадру** — 3 кадра без ожидания обновления буфера
- [ ] **get_photo всегда пишет на диск** — нет ротации, диск забьётся

### PLC.py
- [ ] **Нет обработки ошибок порта** — частичная инициализация оставляет порт открытым
- [ ] **stop() не потокобезопасен** — PortNotOpenError при закрытии во время записи
- [ ] **update_data() не ловит исключения** — поток обновления умирает
- [ ] **Командные биты не сбрасываются** — «залипшие» команды

### camera_manager.py
- [ ] **_is_open не сбрасывается при ошибке** — open() вернёт True при сломанном захвате
- [ ] **Кадр в буфере без копии** — OpenCV может переиспользовать буфер

## Средний приоритет (MEDIUM)

### Application.py
- [ ] **Неизвестные команды молча отбрасываются** — клиент ждёт ACK бесконечно

### inference_service.py
- [ ] **Hot loop при постоянной ошибке** — 100% CPU без паузы

### PLC.py
- [ ] **Регистры как публичные атрибуты** — прямые вызовы обходят _modbus_lock
- [ ] **Глушение логов modbus_tk** — скрывает ошибки связи
- [ ] **Битовые операции без проверки** — можно записать > 0xFFFF

### camera_manager.py
- [ ] **Буфер не очищается при stop** — мегабайты кадров в памяти

### Общее
- [ ] **Таймаут vision 2с < время инференса** — ответ приходит позже
- [ ] **time.sleep(0.1) замедляет реакцию** — пропуск событий датчиков

## Рефакторинг и улучшения

- [ ] **Модульная структура** — выделение core/, io/, handlers/
- [ ] **Ротация логов** — RotatingFileHandler
- [ ] **Мониторинг** — метрики производительности, health checks
- [ ] **Дополнительные тесты** — camera_manager, inference_engine, WebSocket

## Низкий приоритет

- [ ] **Документация API** — OpenAPI/AsyncAPI спецификация
- [ ] **Docker** — контейнеризация сервисов
- [ ] **CI/CD** — автоматическое тестирование и деплой

---

*Последнее обновление: 2025-12-19*
